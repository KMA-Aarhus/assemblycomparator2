---
title: "Assemblycomparator2 Report"
#subtitle: "`r head(tail(unlist(strsplit(getwd(), "/")) ,2) ,1)`" # use the title variable from the pipeline instead somehow
date: "`r Sys.Date()`"
#output:
  #prettydoc::html_pretty:
    #theme: cayman
    #highlight: github
editor_options: 
  chunk_output_type: console
#css: "max-width: 5000px; margin: auto; padding: 1em; line-height: 20px"
---
  
  
```{r echo=FALSE, message=F, warning=F}
#Dependencies
library(tidyverse)
library(prettydoc)
#library(broom)
#library(magrittr)
#library(knitr)
#library(kableExtra)
library(DT)

# This is useful for debugging the markdown script.
debug_dir ="~/assemblycomparator2/tests/E._faecium/output_asscom2/"
setwd(debug_dir)
```

## Sample overview
```{r echo=FALSE, message=F, warning=F}



# Import the metadata table
# This table makes it easy for us later to convert the long paths to short and simple sample names
metadata_file = "metadata.tsv"

if (file.exists(metadata_file)) {
    metadata_df = read_tsv(metadata_file)
    
    
    # Generate a very simple table which can be used to convert long paths to sample names
    metadata_translate = metadata_df %>% 
        select(sample, filename = input_file_fasta)
    
    # Present the metadata in the report
    metadata_df %>%
        arrange(sample) %>% 
        datatable(class = 'cell-border stripe')
    
    
    
} else {
    stop(paste("The metadata file", metadata_file, "is not accessible."))
}


```

## Assembly statistics

Assembly statistics provided by [assembly-stats](https://github.com/sanger-pathogens/assembly-stats#assembly-stats).

```{r echo=FALSE, message=F, warning=F}
assembly_stats_file = "assembly-stats/assembly-stats.tsv"
if (file.exists(assembly_stats_file)) {
    assembly_stats_df = read_tsv(assembly_stats_file) 
    
    assembly_stats_df %>% left_join(metadata_translate) %>% 
        select(sample, everything(), -filename) %>% 
        arrange(sample) %>% 
        datatable(class = 'cell-border stripe')
            
    
    
} else {
    paste("Warning: The file", assembly_stats_file, "is not accessible.")
}
```


## Species

Species identification is provided by [Kraken 2](https://github.com/DerrickWood/kraken2/wiki/About-Kraken-2) using the `r Sys.getenv("$ASSCOM2_BASE")` database.




```{r echo=FALSE, message=F, warning=F}

kraken2_file = "kraken2/kraken2_reports.tsv"
if (file.exists(kraken2_file)) {
    
    
    
    
    kraken2_df = read_tsv(kraken2_file) %>% 
        rename(percent = match_percent)
    
    
    kraken2_df %>% group_by(sample) %>% 
        #filter(level == "S" | level == "U")
        filter(level == "S") %>% 
        mutate(rank = row_number(-percent),
               rank_text = paste("hit", rank),
               clade_text = paste0(percent, "% (", clade, ")")) %>% 
               #clade_text = paste0(clade, " ", match_percent, ")")) %>% 
        
        filter(rank <= 2) %>% 
        pivot_wider(id_cols = sample, names_from = rank_text, values_from = c(percent, clade)) %>% 
        
    
        arrange(sample) %>% 
    
        datatable(class = 'cell-border stripe')
            
    
    
} else {
    paste("Warning: The file", kraken2_file, "is not accessible.")
}
```
`r if (file.exists(kraken2_file)) {paste("Using the", Sys.getenv("ASSCOM2_KRAKEN2_DB"), "database")}`.





## MLST

Multi locus sequence typing provided by [mlst](https://github.com/tseemann/mlst#mlst).
The mlst software incorporates components of the PubMLST database.
```{r echo=FALSE, message=F, warning=F}
#f√• mlst til at spytte header ud.
#mlst <- read.table(file = 'mlst.tsv', sep = '\t', header = FALSE)
mlst_file = "mlst/mlst.tsv"
if (file.exists(mlst_file)) {
    mlst_df <- read_tsv("mlst/mlst.tsv", col_names = F)
    allelnum <- length(mlst_df) - 3
    names(mlst_df) = c("filename", "scheme", "sequence_type", paste('al.', 1:allelnum))
    
    
    mlst_df %>%
        left_join(metadata_translate) %>% 
        select(sample, everything(), -filename) %>% 
        arrange(sample) %>% 
        datatable(class = 'cell-border stripe')
        
    
    #mlst_df %>% datatable(
    #  options = list(
    #   autoWidth = TRUE, 
    #   columnDefs = list(list(width = '300px'))),
      #class = 'cell-border stripe',
      #rownames = FALSE,
      #colnames = c('Isolate','Scheme', 'SequenceType', rep('Allel',allelnum) )
      #)
    
      #kable() %>% 
      #kable_paper('hover', full_width = F)
}
```

```{r echo=FALSE, message=F, warning=F}
##Abricate
#It only supports contigs, not FASTQ reads
#It only detects acquired resistance genes, NOT point mutations
#It uses a DNA sequence database, not protein
#It needs BLAST+ >= 2.7

#uses the 3 databases:
#plasmidfinder
#Ncbi
#card

```


## NCBI Resistance
Resistance genes provided by [NCBI AMRFinder](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6811410/) via [Abricate](https://github.com/tseemann/abricate#abricate).

```{r echo=FALSE, message=F, warning=F}

abricate_ncbi_file = "abricate/ncbi_summarized.tsv"
if (file.exists(abricate_ncbi_file)) {
    abricate_ncbi_df = read_tsv(abricate_ncbi_file) %>% 
        rename(filename = `#FILE`, num_found = NUM_FOUND)
    
    
    abricate_ncbi_df %>%
        left_join(metadata_translate) %>% 
        select(sample, everything(), -filename) %>% 
        arrange(sample) %>% 
        datatable(class = 'cell-border stripe')

    
} else {
    paste("Warning: The file", abricate_ncbi_file, "is not accessible.")
}
```

## Card Resistance genes

```{r echo=FALSE, message=F, warning=F}

abricate_card_file = "abricate/card_summarized.tsv"
if (file.exists(abricate_card_file)) {
    abricate_card_df = read_tsv(abricate_card_file) %>% 
        rename(filename = `#FILE`, num_found = NUM_FOUND)
    
    
    abricate_card_df %>%
        left_join(metadata_translate) %>% 
        select(sample, everything(), -filename) %>% 
        arrange(sample) %>% 
        datatable(class = 'cell-border stripe')

    
} else {
    paste("Warning: The file", abricate_card_file, "is not accessible.")
}
```

## Plasmidfinder calls

```{r echo=FALSE, message=F, warning=F}

abricate_plasmidfinder_file = "abricate/plasmidfinder_summarized.tsv"
if (file.exists(abricate_plasmidfinder_file)) {
    abricate_plasmidfinder_df = read_tsv(abricate_plasmidfinder_file) %>% 
        rename(filename = `#FILE`, num_found = NUM_FOUND)
    
    
    abricate_plasmidfinder_df %>%
        left_join(metadata_translate) %>% 
        select(sample, everything(), -filename) %>% 
        arrange(sample) %>% 
        datatable(class = 'cell-border stripe')

    
} else {
    paste("Warning: The file", abricate_plasmidfinder_file, "is not accessible.")
}
```



##### The [assemblycomparator2 pipeline](https://github.com/cmkobel/assemblycomparator2#assemblycomparator2) and this report is developed by Oliver Hansen & Carl M. Kobel
